rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    function isSignedIn() {
      return request.auth != null;
    }

    function lowerAuthEmail() {
      return request.auth != null && request.auth.token.email != null
        ? lower(request.auth.token.email)
        : null;
    }

    function hasNotificationAccess(resourceData) {
      let targets = resourceData.targets;
      return targets is list && (
        (request.auth != null && request.auth.uid in targets) ||
        (lowerAuthEmail() != null && lowerAuthEmail() in targets)
      );
    }

    match /notifications/{notificationId} {
      allow get, list: if isSignedIn() && hasNotificationAccess(resource.data);

      allow update: if isSignedIn() && hasNotificationAccess(resource.data)
        && request.resource.data.userId == resource.data.userId
        && request.resource.data.type == resource.data.type
        && request.resource.data.channel == resource.data.channel
        && request.resource.data.surfaceTargets == resource.data.surfaceTargets
        && request.resource.data.dedupeKey == resource.data.dedupeKey
        && request.resource.data.targets == resource.data.targets
        && request.resource.data.payload == resource.data.payload
        && request.resource.data.title == resource.data.title
        && request.resource.data.message == resource.data.message
        && request.resource.data.tone == resource.data.tone
        && request.resource.data.actionLabel == resource.data.actionLabel
        && request.resource.data.actionHref == resource.data.actionHref
        && request.resource.data.toast == resource.data.toast
        && request.resource.data.banner == resource.data.banner
        && request.resource.data.userEmail == resource.data.userEmail
        && request.resource.data.read is bool
        && request.resource.data.updatedAt is timestamp
        && (!('dismissedSurfaces' in request.resource.data) || request.resource.data.dismissedSurfaces is map)
        && (!('acknowledgedAt' in request.resource.data) || request.resource.data.acknowledgedAt is timestamp);

      allow create, delete: if false;
    }

    match /{document=**} {
      allow read, write: if false;
    }
  }
}
